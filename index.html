<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Content Factory v7.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --main-bg: #f7fafc; --sidebar-bg: #ffffff; --text-color: #2d3748; --accent-color: #4299e1; --font-serif: 'KaiTi', 'STKaiti', serif; }
        body { font-family: 'Inter', sans-serif; background-color: var(--main-bg); color: var(--text-color); }
        .sidebar-icon { width: 20px; text-align: center; }
        .loader { border-top-color: var(--accent-color); }
        .nav-item.active { background-color: #ebf8ff; color: #2b6cb0; border-right: 4px solid var(--accent-color); font-weight: 600; }
        .prose-styles { max-width: 100%; font-family: var(--font-serif); line-height: 2; font-size: 1.15em; }
        .prose-styles h1, .prose-styles h2, .prose-styles h3 { font-weight: 700; margin-top: 1.5em; margin-bottom: 0.8em; font-family: 'Inter', sans-serif; }
        .showcase-bg, .preview-bg {
            background-color: #fdfcf8;
            border: 1px solid #e2d9c8;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            color: #3a352d;
        }
        #worldview-content-cards .card, #mind-library-list .card, .stat-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #worldview-content-cards .card:hover, #mind-library-list .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .character-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e2e8f0;
        }
        .retry-btn-right {
            float: right;
        }
    </style>
</head>
<body class="flex h-screen">

    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md flex flex-col flex-shrink-0">
        <div class="p-4 border-b flex justify-between items-center">
            <h2 class="text-2xl font-bold text-center">
                <i class="fas fa-brain text-blue-500"></i>
                <span data-translate-key="app_title">AI Factory</span>
            </h2>
            <select id="lang-switcher" class="bg-gray-100 border-gray-300 rounded-md text-sm p-1">
                <option value="en">EN</option>
                <option value="zh">中文</option>
            </select>
        </div>
        <nav class="flex-grow">
            <a href="#" id="nav-creator" class="nav-item flex items-center space-x-3 p-4 text-lg font-medium hover:bg-gray-100 active"><i class="fas fa-plus-circle sidebar-icon"></i><span data-translate-key="nav_creator">Create Project</span></a>
            <a href="#" id="nav-library" class="nav-item flex items-center space-x-3 p-4 text-lg font-medium hover:bg-gray-100"><i class="fas fa-book-open sidebar-icon"></i><span data-translate-key="nav_library">Project Library</span></a>
            <a href="#" id="nav-worldview" class="nav-item flex items-center space-x-3 p-4 text-lg font-medium hover:bg-gray-100"><i class="fas fa-globe-americas sidebar-icon"></i><span data-translate-key="nav_worldview">Worldview</span></a>
            <a href="#" id="nav-mind-library" class="nav-item flex items-center space-x-3 p-4 text-lg font-medium hover:bg-gray-100"><i class="fas fa-clipboard-list sidebar-icon"></i><span data-translate-key="nav_mind_library">Mind Library</span></a>
            <a href="#" id="nav-queue" class="nav-item flex items-center space-x-3 p-4 text-lg font-medium hover:bg-gray-100"><i class="fas fa-tasks sidebar-icon"></i><span data-translate-key="nav_queue">Task Queue</span></a>
            <a href="#" id="nav-showcase" class="nav-item flex items-center space-x-3 p-4 text-lg font-medium hover:bg-gray-100"><i class="fas fa-magic sidebar-icon"></i><span data-translate-key="nav_showcase">Showcase</span></a>
            <a href="#" id="nav-stats" class="nav-item flex items-center space-x-3 p-4 text-lg font-medium hover:bg-gray-100"><i class="fas fa-chart-line sidebar-icon"></i><span data-translate-key="nav_stats">Token Stats</span></a>
        </nav>
        <div class="p-4 border-t">
            <h3 class="text-lg font-semibold mb-2" data-translate-key="logs_title">Logs</h3>
            <div id="log-panel" class="h-48 bg-gray-900 text-white font-mono text-xs rounded-lg p-2 overflow-y-auto"></div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto bg-gray-50">
        <!-- All Views Here... -->
        <div id="view-creator" class="view-panel">
            <h1 class="text-3xl font-bold mb-6" data-translate-key="creator_title">Create New Project</h1>
            <form id="main-form" class="space-y-6 bg-white p-8 rounded-lg shadow-lg">
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2" data-translate-key="creator_topic_label">1. Topic</label>
                    <input type="text" name="topic" id="topic" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3" data-translate-key-placeholder="creator_topic_placeholder">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="outline_type" class="block text-sm font-medium text-gray-700" data-translate-key="creator_type_label">Project Type</label>
                        <select id="outline_type" name="outline_type" class="mt-1 block w-full rounded-md border-gray-300 p-2">
                            <option value="novel" data-translate-key="option_novel">Novel</option>
                            <option value="course" data-translate-key="option_course">Course</option>
                        </select>
                    </div>
                    <div id="novel-options">
                        <label for="word_count" class="block text-sm font-medium text-gray-700" data-translate-key="creator_word_count_label">Chapter Word Count</label>
                        <input type="number" name="word_count" id="word_count" value="2500" class="mt-1 block w-full rounded-md border-gray-300 p-2">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="chapters" class="block text-sm font-medium text-gray-700" data-translate-key="creator_chapters_label">Number of Chapters</label>
                        <input type="number" name="chapters" id="chapters" value="10" class="mt-1 block w-full rounded-md border-gray-300 p-2">
                    </div>
                    <div id="sections-container">
                        <label for="sections" class="block text-sm font-medium text-gray-700" data-translate-key="creator_sections_label">Sections per Chapter</label>
                        <input type="number" name="sections" id="sections" value="4" class="mt-1 block w-full rounded-md border-gray-300 p-2">
                    </div>
                </div>
                <button type="button" id="generate-outline-btn" class="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-lightbulb mr-2"></i><span data-translate-key="creator_generate_btn">Generate Outline</span>
                </button>
            </form>
            <div id="outline-preview-container" class="mt-8 hidden bg-white p-8 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold mb-4" data-translate-key="creator_preview_title">Outline Preview</h3>
                <div id="outline-preview" class="p-4 bg-gray-50 border rounded-md max-h-96 overflow-y-auto whitespace-pre-wrap font-mono"></div>
                <button type="button" id="start-generation-btn" class="mt-6 w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                    <i class="fas fa-play-circle mr-2"></i><span data-translate-key="creator_confirm_btn">Confirm and Start Generation</span>
                </button>
            </div>
        </div>
        <div id="view-library" class="view-panel hidden">
            <h1 class="text-3xl font-bold mb-6" data-translate-key="library_title">Project Library</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="library-grid"></div>
        </div>
        <div id="view-worldview" class="view-panel hidden">
            <h1 class="text-3xl font-bold mb-6" data-translate-key="worldview_title">Novel Worldview</h1>
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="mb-6">
                    <label for="worldview-project-select" class="block text-sm font-medium text-gray-700" data-translate-key="worldview_select_novel">Select Novel</label>
                    <select id="worldview-project-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                </div>
                <div id="worldview-display-container" class="hidden space-y-8">
                    <div id="worldview-content-cards"></div>
                </div>
            </div>
        </div>
        <div id="view-mind-library" class="view-panel hidden">
            <h1 class="text-3xl font-bold mb-6" data-translate-key="mind_library_title">Novel Mind Library</h1>
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="mb-6">
                    <label for="mind-library-project-select" class="block text-sm font-medium text-gray-700" data-translate-key="mind_library_select_novel">Select Novel</label>
                    <select id="mind-library-project-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                </div>
                <div id="mind-library-display-container" class="hidden">
                    <div id="mind-library-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-4"></div>
                </div>
            </div>
        </div>
        <div id="view-preview" class="view-panel hidden">
            <button id="back-to-library-btn" class="mb-6 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded inline-flex items-center">
                <i class="fas fa-arrow-left mr-2"></i><span data-translate-key="preview_back_btn">Back to Library</span>
            </button>
            <div class="flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6">
                <div class="w-full lg:w-1/3 bg-white p-4 rounded-lg shadow-lg flex-shrink-0">
                    <h2 id="preview-title" class="text-xl font-bold mb-4 border-b pb-2 flex justify-between items-center"></h2>
                    <div id="preview-file-tree" class="max-h-[70vh] overflow-y-auto"></div>
                </div>
                <div class="w-full lg:w-2/3 bg-white p-6 rounded-lg shadow-lg preview-bg">
                    <div id="preview-content" class="prose-styles max-h-[75vh] overflow-y-auto p-4"></div>
                </div>
            </div>
        </div>
        <div id="view-queue" class="view-panel hidden">
            <h1 class="text-3xl font-bold mb-6" data-translate-key="queue_title">Task Queue</h1>
            <div id="task-list" class="bg-white p-6 rounded-lg shadow-lg space-y-4"></div>
        </div>
        <div id="view-showcase" class="view-panel hidden">
            <h1 class="text-3xl font-bold mb-6" data-translate-key="showcase_title">AI Writing Showcase</h1>
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end">
                    <div class="md:col-span-1">
                        <label for="showcase-project-select" class="block text-sm font-medium text-gray-700" data-translate-key="showcase_select_novel">Select Novel</label>
                        <select id="showcase-project-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                    </div>
                     <div class="md:col-span-1">
                        <label for="showcase-section-select" class="block text-sm font-medium text-gray-700" data-translate-key="showcase_select_section">Section</label>
                        <select id="showcase-section-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" disabled></select>
                    </div>
                    <div class="md:col-span-1 flex space-x-2">
                        <button id="start-showcase-btn" class="w-full flex items-center justify-center py-2 px-4 rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400" disabled>
                            <i class="fas fa-play mr-2"></i><span data-translate-key="showcase_start_btn">Start</span>
                        </button>
                        <button id="stop-showcase-btn" class="w-full flex items-center justify-center py-2 px-4 rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 hidden">
                            <i class="fas fa-stop mr-2"></i><span data-translate-key="showcase_stop_btn">Stop</span>
                        </button>
                    </div>
                </div>
                <div id="showcase-output-wrapper" class="p-8 rounded-lg showcase-bg h-[60vh] overflow-y-auto">
                    <div id="showcase-output" class="prose-styles"></div>
                </div>
            </div>
        </div>
        <div id="view-stats" class="view-panel hidden">
            <h1 class="text-3xl font-bold mb-6" data-translate-key="stats_title">Token Usage Statistics</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="stat-card p-6 text-center">
                    <h3 class="text-lg font-semibold text-gray-500" data-translate-key="stats_total_prompt">Total Prompt Tokens</h3>
                    <p id="total-prompt-tokens" class="text-4xl font-bold"></p>
                </div>
                <div class="stat-card p-6 text-center">
                    <h3 class="text-lg font-semibold text-gray-500" data-translate-key="stats_total_completion">Total Completion Tokens</h3>
                    <p id="total-completion-tokens" class="text-4xl font-bold"></p>
                </div>
                <div class="stat-card p-6 text-center">
                    <h3 class="text-lg font-semibold text-gray-500" data-translate-key="stats_total">Total Tokens</h3>
                    <p id="total-tokens" class="text-4xl font-bold"></p>
                </div>
            </div>
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <canvas id="token-chart"></canvas>
            </div>
        </div>

        <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
            <p id="loader-text" class="text-white text-xl ml-6"></p>
        </div>
    </main>

    <script>
        // --- Translations, State, DOM Elements... (Mostly unchanged)
        const translations = {
            en: {
                app_title: "AI Factory", nav_creator: "Create Project", nav_library: "Project Library", nav_worldview: "Worldview", nav_mind_library: "Mind Library", nav_queue: "Task Queue", nav_showcase: "Showcase", nav_stats: "Token Stats", logs_title: "Logs", creator_title: "Create New Project", creator_topic_label: "1. Topic", creator_topic_placeholder: "e.g., A story about a time-traveling detective", creator_type_label: "Project Type", option_course: "Course", option_novel: "Novel", creator_word_count_label: "Chapter Word Count", creator_chapters_label: "Number of Chapters", creator_sections_label: "Sections per Chapter", creator_generate_btn: "Generate Outline", creator_preview_title: "Outline Preview", creator_confirm_btn: "Confirm and Start Generation", library_title: "Project Library", library_empty: "No projects found. Create one to get started!", worldview_title: "Novel Worldview", worldview_select_novel: "Select Novel", mind_library_title: "Novel Mind Library", mind_library_select_novel: "Select Novel", preview_back_btn: "Back to Library", preview_select_file: "Select a file to view its content.", queue_title: "Task Queue", queue_empty: "The task queue is empty.", showcase_title: "AI Writing Showcase", showcase_select_novel: "Select Novel", showcase_select_section: "Start Chapter", showcase_start_btn: "Start", showcase_stop_btn: "Stop", showcase_loading: "Loading chapters...", showcase_ready: "Select a novel and a starting chapter to begin.", showcase_finished: "Showcase finished.", stats_title: "Token Usage Statistics", stats_total_prompt: "Total Prompt Tokens", stats_total_completion: "Total Completion Tokens", stats_total: "Total Tokens", status_running: "Running", status_queued: "Queued", status_completed: "Completed", status_cancelled: "Cancelled", status_failed: "Failed", action_cancel: "Cancel", action_download_zip: "ZIP", alert_enter_topic: "Please enter a topic!", alert_task_added: "Task successfully added to the queue!", alert_task_creation_failed: "Task creation failed. The outline might be invalid or empty. Please try generating the outline again.", alert_cancel_confirm: "Are you sure you want to cancel this task?", alert_cancel_success: "Task cancellation successful.", loader_generating_outline: "Generating Outline...", loader_generating_worldview: "Generating Worldview...", loader_generating_mind_library: "Generating Mind Library...", loader_adding_task: "Adding task to queue...", loader_loading_library: "Loading project library...", loader_loading_project: "Loading project...", loader_cancelling_task: "Cancelling task...",
            },
            zh: {
                app_title: "AI 作家", nav_creator: "创建项目", nav_library: "作品库", nav_worldview: "世界观", nav_mind_library: "思维库", nav_queue: "任务队列", nav_showcase: "AI 作家", nav_stats: "Token 统计", logs_title: "日志", creator_title: "创建新项目", creator_topic_label: "1. 主题", creator_topic_placeholder: "例如：一个关于时间旅行侦探的故事", creator_type_label: "项目类型", option_course: "课程", option_novel: "小说", creator_word_count_label: "每章字数", creator_chapters_label: "章节数", creator_sections_label: "每章小节数", creator_generate_btn: "生成大纲", creator_preview_title: "大纲预览", creator_confirm_btn: "确认并开始生成", library_title: "作品库", library_empty: "未找到任何项目。请先创建一个。", worldview_title: "小说世界观", worldview_select_novel: "选择小说", mind_library_title: "小说思维库", mind_library_select_novel: "选择小说", preview_back_btn: "返回作品库", preview_select_file: "请选择一个文件以查看其内容。", queue_title: "任务队列", queue_empty: "任务队列是空的。", showcase_title: "AI 写作秀场", showcase_select_novel: "选择小说", showcase_select_section: "起始章节", showcase_start_btn: "开始", showcase_stop_btn: "停止", showcase_loading: "正在加载章节...", showcase_ready: "请选择一部小说和起始章节。", showcase_finished: "演示已结束。", stats_title: "Token 使用统计", stats_total_prompt: "总输入 Tokens", stats_total_completion: "总输出 Tokens", stats_total: "总消耗 Tokens", status_running: "运行中", status_queued: "排队中", status_completed: "已完成", status_cancelled: "已取消", status_failed: "失败", action_cancel: "取消", action_download_zip: "下载ZIP", alert_enter_topic: "请输入核心主题！", alert_task_added: "任务已成功添加到队列！", alert_task_creation_failed: "任务创建失败。生成的大纲可能无效或为空，请尝试重新生成大纲。", alert_cancel_confirm: "您确定要取消这个任务吗？", alert_cancel_success: "任务已成功取消。", loader_generating_outline: "正在生成大纲...", loader_generating_worldview: "正在创建世界观...", loader_generating_mind_library: "正在创建思维库...", loader_adding_task: "正在添加任务到队列...", loader_loading_library: "正在加载作品库...", loader_loading_project: "正在加载项目...", loader_cancelling_task: "正在取消任务...",
            }
        };
        let currentLang = 'en';
        let typewriterTimeout;
        let isShowcaseRunning = false;
        let completedTaskCount = 0;
        let tokenChart = null;

        const views = { creator: document.getElementById('view-creator'), library: document.getElementById('view-library'), worldview: document.getElementById('view-worldview'), mind_library: document.getElementById('view-mind-library'), preview: document.getElementById('view-preview'), queue: document.getElementById('view-queue'), showcase: document.getElementById('view-showcase'), stats: document.getElementById('view-stats') };
        const navLinks = { creator: document.getElementById('nav-creator'), library: document.getElementById('nav-library'), worldview: document.getElementById('nav-worldview'), mind_library: document.getElementById('nav-mind-library'), queue: document.getElementById('nav-queue'), showcase: document.getElementById('nav-showcase'), stats: document.getElementById('nav-stats') };
        const loader = document.getElementById('loader'), loaderText = document.getElementById('loader-text');
        const logPanel = document.getElementById('log-panel');
        const langSwitcher = document.getElementById('lang-switcher');

        const worldviewProjectSelect = document.getElementById('worldview-project-select');
        const worldviewDisplayContainer = document.getElementById('worldview-display-container');
        const worldviewContentCards = document.getElementById('worldview-content-cards');

        const mindLibraryProjectSelect = document.getElementById('mind-library-project-select');
        const mindLibraryDisplayContainer = document.getElementById('mind-library-display-container');
        const mindLibraryList = document.getElementById('mind-library-list');

        const showcaseProjectSelect = document.getElementById('showcase-project-select');
        const showcaseSectionSelect = document.getElementById('showcase-section-select');
        const startShowcaseBtn = document.getElementById('start-showcase-btn');
        const stopShowcaseBtn = document.getElementById('stop-showcase-btn');
        const showcaseOutput = document.getElementById('showcase-output');

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('ai-factory-lang', lang);
            langSwitcher.value = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                el.innerText = translations[lang][key] || el.innerText;
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-key-placeholder');
                el.placeholder = translations[lang][key] || el.placeholder;
            });
        }

        langSwitcher.addEventListener('change', (e) => setLanguage(e.target.value));

        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navLinks).forEach(l => l.classList.remove('active'));
            views[viewName].classList.remove('hidden');
            navLinks[viewName].classList.add('active');
            stopShowcase();
            if (viewName === 'library') loadLibrary();
            if (viewName === 'worldview') loadWorldviewProjects();
            if (viewName === 'mind_library') loadMindLibraryProjects();
            if (viewName === 'queue') updateTaskQueueView();
            if (viewName === 'showcase') loadShowcaseProjects();
            if (viewName === 'stats') loadTokenStats();
        }

        Object.keys(navLinks).forEach(key => navLinks[key].addEventListener('click', (e) => { e.preventDefault(); switchView(key); }));

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `API call failed: ${response.statusText}`);
                }
                return options.raw ? response : response.json();
            } catch (error) {
                console.error(`Error calling ${endpoint}:`, error);
                alert(`An error occurred: ${error.message}`);
                hideLoader();
                return null;
            }
        }
        function showLoader(textKey) { loaderText.innerText = translations[currentLang][textKey]; loader.classList.remove('hidden'); }
        function hideLoader() { loader.classList.add('hidden'); }

        // --- Creator View Logic ---
        function toggleCreatorOptions() {
            const type = document.getElementById('outline_type').value;
            document.getElementById('novel-options').style.display = type === 'novel' ? 'block' : 'none';
            document.getElementById('sections-container').style.display = type === 'course' ? 'block' : 'none';
        }
        document.getElementById('outline_type').addEventListener('change', toggleCreatorOptions);

        document.getElementById('generate-outline-btn').addEventListener('click', async () => {
            const topic = document.getElementById('topic').value;
            if (!topic) { alert(translations[currentLang].alert_enter_topic); return; }
            showLoader('loader_generating_outline');
            const data = Object.fromEntries(new FormData(document.getElementById('main-form')).entries());
            const result = await apiCall('/generate-outline', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            hideLoader();
            if (result) {
                document.getElementById('outline-preview').innerText = result.outline;
                document.getElementById('outline-preview-container').classList.remove('hidden');
            }
        });
        document.getElementById('start-generation-btn').addEventListener('click', async () => {
            const taskData = {
                original_topic: document.getElementById('topic').value,
                outline: document.getElementById('outline-preview').innerText,
                outline_type: document.getElementById('outline_type').value,
                word_count: document.getElementById('word_count').value
            };
            showLoader('loader_adding_task');
            const result = await apiCall('/start-task', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(taskData) });
            hideLoader();
            if (result) {
                if(result.status === 'success') {
                    alert(translations[currentLang].alert_task_added);
                    document.getElementById('main-form').reset();
                    toggleCreatorOptions();
                    document.getElementById('outline-preview-container').classList.add('hidden');
                    switchView('queue');
                } else {
                    alert(translations[currentLang].alert_task_creation_failed + ` (${result.error})`);
                }
            }
        });

        // --- Library, Worldview, Mind Library, etc. ---
        // (These sections are largely the same as V4, so they are omitted for brevity but are included in the full code)
        async function loadLibrary() {
            showLoader('loader_loading_library');
            const projects = await apiCall('/library');
            hideLoader();
            const libraryGrid = document.getElementById('library-grid');
            libraryGrid.innerHTML = '';
            if (projects && (projects.course.length > 0 || projects.novel.length > 0)) {
                const renderProject = (p, type) => {
                    const icon = type === 'course' ? 'fa-chalkboard-teacher' : 'fa-book';
                    const typeText = type === 'course' ? translations[currentLang].option_course : translations[currentLang].option_novel;
                    return `<div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer" onclick="loadProjectPreview('${type}', '${p}')">
                        <div class="flex items-center space-x-4"> <i class="fas ${icon} text-3xl text-blue-500"></i> <div> <h3 class="text-lg font-bold">${p}</h3> <p class="text-sm text-gray-500">${typeText}</p> </div> </div>
                    </div>`;
                };
                projects.course.forEach(p => libraryGrid.innerHTML += renderProject(p, 'course'));
                projects.novel.forEach(p => libraryGrid.innerHTML += renderProject(p, 'novel'));
            } else {
                libraryGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center">${translations[currentLang].library_empty}</p>`;
            }
        }
        async function loadProjectPreview(type, project) {
            showLoader('loader_loading_project');
            const data = await apiCall(`/library/${type}/${project}`);
            console.log(data)
            hideLoader();
            if (data) {
                document.getElementById('preview-title').innerHTML = `<i class="fas ${type === 'course' ? 'fa-chalkboard-teacher' : 'fa-book'} mr-2"></i> ${data.name}
                    <a href="/download/zip/${type}/${project}" class="text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-full ml-4">
                        <i class="fas fa-download mr-1"></i>${translations[currentLang].action_download_zip}
                    </a>`;

                let treeHtml = '';
                if (type === 'novel') {
                    treeHtml += `<ul class="pl-4 ml-2">`;
                    data.tree.forEach((file) => {
                        console.log(file)
                         const filepath = encodeURIComponent(file);
                         treeHtml += `<li class="py-1"><a href="#" class="text-gray-600 hover:text-blue-600" onclick="loadFileContent(event, '${type}', '${project}', '${filepath}')">${file.replace('.md','')}</a><button class="retry-btn bg-blue-500 text-white px-2 py-1 rounded retry-btn-right" onclick="retryTask('${data.taskId.taskId}', '${type}', '${project}', '${file.replace('.md','')}')">重试</button></li>`;
                    });
                    treeHtml += `</ul>`;
                } else { // Course
                    for (const chapter in data.tree) {
                        treeHtml += `<div class="mt-2"> <h4 class="font-semibold text-gray-700"><i class="fas fa-folder-open mr-2 text-yellow-500"></i>${chapter}</h4> <ul class="pl-4 border-l-2 border-gray-200 ml-2">`;
                        data.tree[chapter].forEach((file) => {
                            const filepath = encodeURIComponent(`${chapter}/${file}`);
                            treeHtml += `<li class="py-1"><a href="#" class="text-gray-600 hover:text-blue-600" onclick="loadFileContent(event, '${type}', '${project}', '${filepath}')">${file.replace('.md','')}</a></li>`;
                        });
                        treeHtml += `</ul></div>`;
                    }
                }

                document.getElementById('preview-file-tree').innerHTML = treeHtml;
                document.getElementById('preview-content').innerHTML = `<span>${translations[currentLang].preview_select_file}</span>`;
                switchView('preview');
            }
        }
        async function loadFileContent(event, type, project, filepath) {
            event.preventDefault();
            document.getElementById('preview-content').innerHTML = 'Loading...';
            const data = await apiCall(`/library/content/${type}/${project}/${filepath}`);
            if (data) { document.getElementById('preview-content').innerHTML = marked.parse(data.content); }
        }
        document.getElementById('back-to-library-btn').addEventListener('click', () => switchView('library'));

        function parseWorldview(mdContent) {
            const sections = mdContent.split('### ').slice(1);
            const worldview = {};
            sections.forEach(section => {
                const lines = section.split('\\n');
                const title = lines[0].trim();
                const content = lines.slice(1).join('\\n').trim();
                if (title.includes('主要人物')) {
                    worldview.characters = content.split('---').map(charBlock => {
                        const charData = {};
                        charBlock.trim().split('\\n').forEach(line => {
                            const parts = line.split(':');
                            if (parts.length > 1) {
                                const key = parts[0].replace(/\\*\\*/g, '').trim();
                                const value = parts.slice(1).join(':').trim();
                                charData[key] = value;
                            }
                        });
                        return charData;
                    }).filter(c => c['姓名']);
                } else {
                    worldview[title] = content;
                }
            });
            return worldview;
        }

        function renderWorldview(worldview) {
            let html = '<div class="space-y-6">';
            if (worldview.characters) {
                html += '<div><h3 class="text-2xl font-bold mb-4">主要人物</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
                worldview.characters.forEach(char => {
                    html += `<div class="card p-6 flex flex-col items-center text-center"><img src="https://i.pravatar.cc/150?u=${encodeURIComponent(char['姓名'])}" alt="Avatar" class="character-avatar mb-4"><h4 class="text-lg font-bold">${char['姓名'] || 'N/A'}</h4><p class="text-sm text-gray-500 mb-2">${char['身份/背景'] || ''}</p></div>`;
                });
                html += '</div></div>';
            }
            for (const [title, content] of Object.entries(worldview)) {
                if (title !== 'characters') {
                    html += `<div class="card p-6"><h3 class="text-xl font-bold mb-2">${title}</h3><div class="prose max-w-none text-sm">${marked.parse(content.replace(/\\n/g, '\\n'))}</div></div>`;
                }
            }
            html += '</div>';
            worldviewContentCards.innerHTML = html;
        }

        async function loadWorldviewProjects() {
            worldviewProjectSelect.innerHTML = `<option value="">---</option>`;
            worldviewDisplayContainer.classList.add('hidden');
            const projects = await apiCall('/library');
            if (projects && projects.novel.length > 0) {
                projects.novel.forEach(p => { worldviewProjectSelect.innerHTML += `<option value="${p}">${p}</option>`; });
            }
        }
        worldviewProjectSelect.addEventListener('change', async (e) => {
            const projectName = e.target.value;
            if (!projectName) { worldviewDisplayContainer.classList.add('hidden'); return; }
            const data = await apiCall(`/api/worldview/${projectName}`);
            if (data && data.content) {
                const parsed = parseWorldview(data.content.replace(/\\n/g, '\\n'));
                renderWorldview(parsed);
                worldviewDisplayContainer.classList.remove('hidden');
            } else {
                 worldviewContentCards.innerHTML = 'No worldview found.';
                 worldviewDisplayContainer.classList.remove('hidden');
            }
        });

        async function loadMindLibraryProjects() {
            mindLibraryProjectSelect.innerHTML = `<option value="">---</option>`;
            mindLibraryDisplayContainer.classList.add('hidden');
            const projects = await apiCall('/library');
            if (projects && projects.novel.length > 0) {
                projects.novel.forEach(p => { mindLibraryProjectSelect.innerHTML += `<option value="${p}">${p}</option>`; });
            }
        }
        mindLibraryProjectSelect.addEventListener('change', async (e) => {
            const projectName = e.target.value;
            if (!projectName) { mindLibraryDisplayContainer.classList.add('hidden'); return; }
            const data = await apiCall(`/api/mind-library/${projectName}`);
            if (data && data.library) {
                renderMindLibrary(data.library);
                mindLibraryDisplayContainer.classList.remove('hidden');
            } else {
                mindLibraryList.innerHTML = 'No mind library found.';
                mindLibraryDisplayContainer.classList.remove('hidden');
            }
        });

        function renderMindLibrary(library) {
            let html = '';
            library.forEach((item, index) => {
                const statusColor = item.status === 'completed' ? 'bg-green-100 border-green-500' : 'bg-yellow-100 border-yellow-500';
                const statusIcon = item.status === 'completed' ? 'fa-check-circle text-green-500' : 'fa-clock text-yellow-500';
                html += `<div class="card p-4 ${statusColor} border-l-4"><div class="flex justify-between items-center"><h4 class="text-lg font-bold text-gray-800">${index + 1}. ${item.chapter_title}</h4><i class="fas ${statusIcon}"></i></div><p class="text-sm text-gray-600 mt-2">${item.summary}</p></div>`;
            });
            mindLibraryList.innerHTML = html;
        }

        // --- Token Stats View Logic (New) ---
        async function loadTokenStats() {
            const data = await apiCall('/api/token-stats');
            if (!data) return;

            document.getElementById('total-prompt-tokens').textContent = data.total_prompt_tokens.toLocaleString();
            document.getElementById('total-completion-tokens').textContent = data.total_completion_tokens.toLocaleString();
            document.getElementById('total-tokens').textContent = (data.total_prompt_tokens + data.total_completion_tokens).toLocaleString();

            const dailyStats = data.daily_stats || {};
            const sortedDates = Object.keys(dailyStats).sort();

            const labels = sortedDates;
            const promptData = sortedDates.map(date => dailyStats[date].prompt_tokens);
            const completionData = sortedDates.map(date => dailyStats[date].completion_tokens);

            const ctx = document.getElementById('token-chart').getContext('2d');
            if(tokenChart) {
                tokenChart.destroy();
            }
            tokenChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Prompt Tokens',
                            data: promptData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Completion Tokens',
                            data: completionData,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true },
                        x: { stacked: true }
                    },
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Daily Token Usage' }
                    }
                }
            });
        }

        // --- Other functions (Queue, Showcase, etc.) ---
        // (These sections are largely the same as V4, so they are omitted for brevity but are included in the full code)
        async function updateTaskQueueView() {
            const data = await apiCall('/tasks');
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            if (data && data.length > 0) {
                data.forEach(task => {
                    let statusColor = 'bg-gray-400';
                    if (task.status === 'running') statusColor = 'bg-blue-500';
                    if (task.status === 'completed') statusColor = 'bg-green-500';
                    if (task.status === 'cancelled') statusColor = 'bg-orange-500';
                    if (task.status === 'failed') statusColor = 'bg-red-500';
                    const statusText = translations[currentLang][`status_${task.status}`] || task.status;
                    taskList.innerHTML += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex items-center"><span class="inline-block w-3 h-3 ${statusColor} rounded-full mr-3"></span><div> <span class="font-medium">${task.topic}</span> <span class="text-xs text-gray-500 ml-2">(${statusText})</span> </div></div>${task.status === 'queued' || task.status === 'running' ? `<button class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded" onclick="cancelTask('${task.id}')"><i class="fas fa-trash-alt mr-1"></i>${translations[currentLang].action_cancel}</button>` : ''}</div>`;
                });
            } else {
                taskList.innerHTML = `<p class="text-gray-500 text-center">${translations[currentLang].queue_empty}</p>`;
            }
        }
        async function cancelTask(taskId) {
            if (!confirm(translations[currentLang].alert_cancel_confirm)) return;
            showLoader('loader_cancelling_task');
            const result = await apiCall(`/tasks/cancel/${taskId}`, { method: 'POST' });
            hideLoader();
            if (result) {
                alert(translations[currentLang].alert_cancel_success);
                updateTaskQueueView();
            }
        }
        async function loadShowcaseProjects() {
            showcaseProjectSelect.innerHTML = `<option value="">---</option>`;
            showcaseSectionSelect.innerHTML = `<option value="">---</option>`;
            showcaseSectionSelect.disabled = true;
            startShowcaseBtn.disabled = true;
            showcaseOutput.innerHTML = `<span class="text-gray-400">${translations[currentLang].showcase_ready}</span>`;
            const projects = await apiCall('/library');
            if (projects && projects.novel.length > 0) {
                projects.novel.forEach(p => { showcaseProjectSelect.innerHTML += `<option value="${p}">${p}</option>`; });
            }
        }
        showcaseProjectSelect.addEventListener('change', async (e) => {
            const projectName = e.target.value;
            showcaseSectionSelect.innerHTML = `<option value="">---</option>`;
            showcaseSectionSelect.disabled = true;
            startShowcaseBtn.disabled = true;
            if (!projectName) return;
            const projectDetails = await apiCall(`/library/novel/${projectName}`);
            if (projectDetails && projectDetails.tree) {
                projectDetails.tree.forEach(chapterFile => {
                    showcaseSectionSelect.innerHTML += `<option value="${chapterFile}">${chapterFile.replace('.md','')}</option>`;
                });
                showcaseSectionSelect.disabled = false;
            }
        });
        showcaseSectionSelect.addEventListener('change', (e) => { startShowcaseBtn.disabled = !e.target.value; });
        function typeWriter(element, text, onFinished, index = 0) {
            if (!isShowcaseRunning) { element.innerHTML = marked.parse(text); return; }
            if (index < text.length) {
                element.innerHTML = marked.parse(text.substring(0, index + 1));
                element.parentElement.scrollTop = element.parentElement.scrollHeight;
                const delay = (text[index] === '，' || text[index] === '。') ? 150 : 30;
                typewriterTimeout = setTimeout(() => typeWriter(element, text, onFinished, index + 1), delay);
            } else {
                 if (onFinished) onFinished();
            }
        }
        async function runShowcaseQueue(sections) {
            if (!isShowcaseRunning || sections.length === 0) {
                stopShowcase();
                showcaseOutput.innerHTML += `<br/><br/><p class="text-center font-bold">${translations[currentLang].showcase_finished}</p>`;
                return;
            }
            const nextSection = sections.shift();
            typeWriter(showcaseOutput, nextSection.content, () => {
                setTimeout(() => runShowcaseQueue(sections), 2500);
            });
        }
        function updateTaskQueueView() {
    const taskList = document.getElementById('task-list');
    taskList.innerHTML = '';
    tasks.forEach(task => {
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        taskItem.dataset.taskId = task.id;
        taskItem.innerHTML = `
            <span>${task.topic}</span>
            <span>${task.status}</span>
            ${task.status === 'failed' ? `<button class="retry-btn bg-blue-500 text-white px-2 py-1 rounded retry-btn-right" onclick="retryTask('${task.id}')">重试</button>` : ''}
        `;
        taskList.appendChild(taskItem);
    });
}

async function retryTask(taskId, type, project, filepath) {
            // console.log(taskId)
    const response = await fetch(`/tasks/retry/${taskId}/${filepath}`, { method: 'POST' });
    if (response.ok) {
        alert('任务已重试');
        updateTaskQueueView();
    } else {
        alert('重试失败');
    }
}

        function stopShowcase() {
            isShowcaseRunning = false;
            clearTimeout(typewriterTimeout);
            startShowcaseBtn.classList.remove('hidden');
            stopShowcaseBtn.classList.add('hidden');
            showcaseProjectSelect.disabled = false;
            showcaseSectionSelect.disabled = false;
        }
        startShowcaseBtn.addEventListener('click', async () => {
            const projectName = showcaseProjectSelect.value;
            const sectionName = showcaseSectionSelect.value;
            if (!projectName || !sectionName) return;
            isShowcaseRunning = true;
            startShowcaseBtn.classList.add('hidden');
            stopShowcaseBtn.classList.remove('hidden');
            showcaseProjectSelect.disabled = true;
            showcaseSectionSelect.disabled = true;
            showcaseOutput.innerHTML = `<span class="text-gray-400">${translations[currentLang].showcase_loading}</span>`;
            const data = await apiCall(`/api/showcase-sequence/${projectName}/${encodeURIComponent(sectionName)}`);
            if (data && data.sections) { runShowcaseQueue(data.sections); }
            else { showcaseOutput.innerText = 'Could not load section sequence.'; stopShowcase(); }
        });
        stopShowcaseBtn.addEventListener('click', stopShowcase);

        // --- Logging & Auto-Refresh ---
        function appendLog(log) {
            if (logPanel.innerText.startsWith('Welcome!')) { logPanel.innerHTML = ''; }
            const logLine = document.createElement('div');
            logLine.innerHTML = `<span>${new Date(log.timestamp * 1000).toLocaleTimeString()}:</span> <span class="text-gray-300">${log.message}</span>`;
            logPanel.appendChild(logLine);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        setInterval(async () => {
            const tasks = await apiCall('/tasks');
            if(views.queue.offsetParent !== null) { updateTaskQueueView(); }
            const newCompletedCount = tasks.filter(t => t.status === 'completed').length;
            if (newCompletedCount > completedTaskCount) {
                console.log("New task completed, refreshing views...");
                if (views.library.offsetParent !== null) loadLibrary();
                if (views.showcase.offsetParent !== null) loadShowcaseProjects();
                if (views.worldview.offsetParent !== null) {
                    const selectedProject = worldviewProjectSelect.value;
                    loadWorldviewProjects().then(() => {
                        if (selectedProject) {
                            worldviewProjectSelect.value = selectedProject;
                            worldviewProjectSelect.dispatchEvent(new Event('change'));
                        }
                    });
                }
                if (views.mind_library.offsetParent !== null) {
                    const selectedProject = mindLibraryProjectSelect.value;
                    loadMindLibraryProjects().then(() => {
                        if (selectedProject) {
                            mindLibraryProjectSelect.value = selectedProject;
                            mindLibraryProjectSelect.dispatchEvent(new Event('change'));
                        }
                    });
                }
            }
            completedTaskCount = newCompletedCount;
            const logs = await apiCall('/status');
            if (logs) logs.forEach(appendLog);
        }, 3000);

        // --- Initialization ---
        const savedLang = localStorage.getItem('ai-factory-lang') || 'zh';
        setLanguage(savedLang);
        toggleCreatorOptions();
        switchView('creator');
        logPanel.innerHTML = 'Welcome! Waiting for tasks...';
    </script>
</body>
</html>